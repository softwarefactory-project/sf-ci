---
# * Submit and wait config repo change
# * Check for SUCCESS in config-update post job log
- hosts: install-server
  remote_user: root
  tasks:
    - name: Submit and approve config change
      command: chdir={{ config_path }} /usr/share/sf-config/scripts/submit_and_wait.py --approve
      register: submit_status
      ignore_errors: true

    - command: chdir={{ config_path }} cat .git/refs/heads/master
      register: commitsha

    - block:
        - name: Wait config-update result using managesf API
          when: sf_zuul_executor == '0'
          uri:
            url: "http://localhost:20001/v2/builds/?job_name=config-update&ref={{ commitsha.stdout }}&in_progress=false"
            return_content: yes
            status_code: "200,404"
          register: job
          until: job.json.results
          retries: 120
          delay: 2
        - name: Abort if config-update job failed
          fail: msg="Config-update job failed"
          when: not job.json.results or job.json.results[0]["result"] != "SUCCESS"
      when: sf_zuul_executor == '0'

    - block:
        - name: Wait config-update result using zuul-web API via manageSF
          uri:
            url: "https://{{ sf_domain | default('sftests.com') }}/manage/v2/zuul/local/builds.json?job_name=config-update&newrev={{ commitsha.stdout }}"
            return_content: yes
            status_code: "200,404"
            validate_certs: no
          register: job
          until: "'json' in job and job.json"
          retries: 120
          delay: 2
        - debug: "msg={{ job }}"
        - name: Abort if config-update job failed
          fail: msg="Config-update job failed"
          when: job.json[0]["result"] != "SUCCESS"
      when: sf_zuul_executor == '1'
