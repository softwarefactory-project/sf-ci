---
# * Submit and wait config repo change
# * Check for SUCCESS in config-update post job log
- hosts: zuul-executor
  remote_user: root
  tasks:
    - name: Set executor to verbose
      command: /opt/rh/rh-python35/root/usr/bin/zuul-executor verbose

- hosts: install-server
  remote_user: root
  tasks:
    - name: Submit and approve config change
      command: chdir={{ config_path }} /usr/share/sf-config/scripts/submit_and_wait.py --approve
      register: submit_status
      ignore_errors: true

    - command: chdir={{ config_path }} cat .git/refs/heads/master
      register: commitsha

    - name: Wait config-update result using zuul-web API
      uri:
        url: "https://{{ sf_domain | default('sftests.com') }}/zuul/local/builds?job_name=config-update&newrev={{ commitsha.stdout }}"
        return_content: yes
        status_code: "200,404"
        validate_certs: no
      register: job
      until: "'json' in job and job.json"
      retries: 120
      delay: 2

    - debug: "msg={{ job }}"

    - name: Abort if config-update job failed
      fail: msg="Config-update job failed"
      when: job.json[0]["result"] != "SUCCESS"

- hosts: zuul-executor
  remote_user: root
  tasks:
    - name: Set executor to un-verbose
      command: /opt/rh/rh-python35/root/usr/bin/zuul-executor unverbose
