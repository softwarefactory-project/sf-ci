---
# * Submit and wait config repo change
# * Check for SUCCESS in config-update post job log
- hosts: install-server
  remote_user: root
  tasks:
    - name: Submit and approve config change
      command: chdir={{ config_path }} /usr/share/sf-config/scripts/submit_and_wait.py --approve
      register: submit_status
      ignore_errors: true

    - command: chdir={{ config_path }} cat .git/refs/heads/master
      register: commitsha

    - name: Wait config-update result
      uri:
        url: "http://localhost:20001/v2/builds/?job_name=config-update&ref={{ commitsha.stdout }}&in_progress=false"
        return_content: yes
        status_code: "200,404"
      register: job
      until: job.json.results
      retries: 60
      delay: 2

    - name: Abort if config-update job failed
      fail: msg="Config-update job failed"
      when: not job.json.results or job.json.results[0]["result"] != "SUCCESS"
