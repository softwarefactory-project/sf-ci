---
- hosts: install-server
  remote_user: root
  tasks:
    - name: Reset  config_path checkout and update to origin/master
      block:
        - name: Get config repo state
          command: git status -s
          args:
            chdir: "{{ config_path }}"
          register: git_status

        - name: Print config repo git status
          debug:
            msg: '{{ ### DEBUG ### git status stdout: git_status.stdout }}'

        - name: Clone config repo
          git:
            repo: "http://{{ fqdn }}/r/config"
            dest: "{{ config_path }}"
            update: no

        - name: Reset config
          command: "{{ item }}"
          args:
            chdir: "{{ config_path }}"
          with_items:
            - git fetch --all
            - git checkout master
            - git reset --hard origin/master --
            - git clean -f -d
