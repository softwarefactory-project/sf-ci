---
- hosts: install-server
  remote_user: root
  tasks:
    - name: Checkout tdpw/python-readerlib
      git:
        repo: https://{{ fqdn }}/r/tdpw/python-readerlib
        dest: /var/lib/software-factory/health-check/python-readerlib

    - name: Add python-readerlib to zuul3 main.yaml
      copy:
        content: "{{ zuul3_config|to_yaml }}"
        dest: "{{ config_path }}/zuulV3/health-check.yaml"
      register: zuul3_conf

    - name: Update change
      when: zuul3_conf|changed
      command: chdir={{ config_path }}  {{ item }}
      with_items:
          - 'git add -A'
          - 'git commit -m "Add zuulV3 health-check configuration"'

- name: "Submit config repos"
  include: playbooks/config_submit_change.yaml
  when: zuul3_conf|changed

- hosts: install-server
  remote_user: root
  tasks:
    - name: Add bad configuration
      template:
        src: "{{ item.src }}.j2"
        dest: "/var/lib/software-factory/health-check/python-readerlib/{{ item.dst }}"
      with_items:
        - {src: zuul.yaml, dst: .zuul.yaml}
        - {src: bad.yaml, dst: file.yaml}
      register: bad_project_status

    - name: Submit bad change and check for test error
      command: "{{ item }}"
      args:
        chdir: /var/lib/software-factory/health-check/python-readerlib/
      with_items:
        - git add .zuul.yaml file.yaml
        - git commit -m "Test project"
        - /usr/share/sf-config/scripts/submit_and_wait.py --delay 1200 --failure
      when: bad_project_status|changed

    - name: Add good configuration
      template:
        src: "{{ item.src }}.j2"
        dest: "/var/lib/software-factory/health-check/python-readerlib/{{ item.dst }}"
      with_items:
        - {src: good.yaml, dst: file.yaml}
      register: good_project_status

    - name: Update change and check for SUCCESS
      command: "{{ item }}"
      args:
        chdir: /var/lib/software-factory/health-check/python-readerlib/
      with_items:
        - git commit -a --amend
        - /usr/share/sf-config/scripts/submit_and_wait.py --delay 1200 --approve
        - git fetch --all
      environment: {'EDITOR':'test'}
      when: good_project_status|changed

    - name: "Check change was merged"
      command: chdir=/var/lib/software-factory/health-check/python-readerlib/ git diff HEAD origin/master
      register: diff
      failed_when: diff.stdout != ''
