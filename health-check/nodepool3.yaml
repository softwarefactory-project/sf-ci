---
- hosts: install-server
  remote_user: root
  tasks:
    - name: "Set fact zuul_executor"
      set_fact:
        # Set it to '1' if zuul3 is the config-update executor
        sf_zuul_executor: "{{ sf_zuul_executor | default('0') }}"

- hosts: nodepool3-launcher
  remote_user: root
  tasks:
    - name: "Check service nodepool3-launcher"
      command: systemctl status rh-python35-nodepool-launcher
      register: nodepool3_launcher_service

    - name: "Check service nodepool3-launcher errors"
      fail: msg='Nodepool3 launcher service is not happy'
      when: nodepool3_launcher_service.stdout.lower().find("fail") != -1

- hosts: nodepool3-builder
  remote_user: root
  tasks:
    - name: "Check service nodepool3-builder"
      command: systemctl status rh-python35-nodepool-builder
      register: nodepool3_builder_service

    - name: "Check service nodepool3-builder errors"
      fail: msg='Nodepool3 builder service is not happy'
      when: nodepool3_builder_service.stdout.lower().find("fail") != -1

- name: "Reset config repos"
  include: playbooks/config_reset.yaml

- hosts: install-server
  remote_user: root
  tasks:
    - name: Adds nodepool configuration
      template:
        src: templates/nodepool3.yaml.j2
        dest: "{{ config_path }}/nodepoolV3/nodepool.yaml"

    - name: Update change
      register: changed
      command: 'git commit -a -m "Add {{ provider_name }} provider"'
      args:
        chdir: "{{ config_path }}"
      environment: {'EDITOR':'test'}
      failed_when: changed.rc >= 2

- name: "Submit config repos"
  include: playbooks/config_submit_change.yaml
  when: changed.rc == 0

- hosts: nodepool-builder
  remote_user: root
  tasks:
    - name: "Wait for image to be ready"
      shell: nodepool3 image-list | egrep ".*np3-dib-centos-7.*ready.*"
      register: result
      until: result|success
      retries: 30
      delay: 10

    - name: "Wait for an instance to be ready"
      shell: nodepool3 list | egrep ".*np3-dib-centos-7.*ready.*"
      register: result
      until: result|success
      retries: 30
      delay: 10

- hosts: install-server
  remote_user: root
  tasks:
    - name: "Find node IP address"
      shell: openstack server list -f json
      register: result
      environment:
        OS_CLOUD: "{{ provider_name }}"

    - name: "Get node fip"
      command: |
        python -c 'import json, subprocess
        cmd = "openstack server list -f json"
        ret = json.loads(subprocess.check_output(cmd, shell=True))
        ret = [e["Networks"] for e in ret if e["Name"].startswith("np3-dib-centos-7")][0]
        print ret.split(",")[-1].strip()'
      environment:
        OS_CLOUD: "{{ provider_name }}"
      register: result

- hosts: zuul-launcher
  remote_user: root
  tasks:
    - name: "SSH into node with the test key"
      command: ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o PasswordAuthentication=no -q -i /var/opt/rh/rh-python35/lib/nodepool/.ssh/id_rsa zuul@{{ result.stdout }} whoami


# TODO: We will need to implement that
#- hosts: install-server
#  remote_user: root
#  tasks:
#    - name: "Query the nodes REST API to get last node info"
#      uri:
#        url: http://managesf:20001/nodes/
#        HEADER_X-Remote-User: admin
#        return_content: yes
#        body_format: json
#      register: nodes_info
#
#    - name: "Node API returned value"
#      debug: var=nodes_info.json
#
#    - name: "Hold the node with the REST API"
#      uri:
#        url: http://managesf:20001/nodes/id/{{ nodes_info.json['nodepool'][0]['node_id'] }}
#        HEADER_X-Remote-User: admin
#
#    - name: "Create a test ssh key"
#      command: ssh-keygen -N '' -f /tmp/{{ nodes_info.json['nodepool'][0]['node_name'] }}_id_rsa
#
#    - name: "Read test ssh key"
#      command: cat /tmp/{{ nodes_info.json["nodepool"][0]["node_name"] }}_id_rsa.pub
#      register: tmp_key
#
#    - name: "Add the test ssh key to node's authorized keys with the REST API"
#      uri:
#        url: http://managesf:20001/nodes/id/{{ nodes_info.json['nodepool'][0]['node_id'] }}/authorize_key/
#        method: POST
#        body: "public_key={{ tmp_key.stdout|urlencode() }}"
#        HEADER_X-Remote-User: admin
#        return_content: yes
#      register: ak_output
#      failed_when: "'OK' not in ak_output.content"
#
#    - name: "SSH into node with the test key"
#      command: ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -q -i /tmp/{{ nodes_info.json.nodepool.0.node_name }}_id_rsa jenkins@{{ nodes_info.json.nodepool.0.ip }} whoami
#      register: ssh_whoami
#      failed_when: ssh_whoami.stdout.find("jenkins") == -1
#
#    - name: "Schedule node for deletion"
#      uri:
#        url: http://managesf:20001/nodes/id/{{ nodes_info.json.nodepool.0.node_id }}/
#        method: DELETE
#        HEADER_X-Remote-User: admin
#        return_content: yes
#      register: del_node
#      failed_when: "'delete' not in del_node.content"
#
#    - name: "Delete test ssh key"
#      file:
#        path: "/tmp/{{ nodes_info.json.nodepool.0.node_name }}_{{ item }}"
#        state: absent
#      with_items:
#        - "id_rsa"
#        - "id_rsa.pub"
