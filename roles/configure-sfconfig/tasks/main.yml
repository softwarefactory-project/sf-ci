---
- name: Configure sfconfig
  block:
    - name: Install SF architecture file {{ sf_arch }}.yaml
      copy:
        src: "/usr/share/sf-config/refarch/{{ sf_arch }}.yaml"
        dest: /etc/software-factory/arch.yaml
        remote_src: true

    - name: Fix default nodeset to pod-centos-7
      replace:
        path: /etc/software-factory/sfconfig.yaml
        regexp: runc-centos
        replace: pod-centos-7

    - name: Activate hypervisor-oci role in arch.yaml
      lineinfile:
        path: /etc/software-factory/arch.yaml
        insertafter: '      - nodepool-launcher'
        line: '      - hypervisor-oci'
      when: add_runc_hypervisor

    - name: Activate hypervisor-k1s role in arch.yaml
      lineinfile:
        path: /etc/software-factory/arch.yaml
        insertafter: '      - nodepool-launcher'
        line: '      - hypervisor-k1s'
      when: add_k1s_hypervisor

    - name: Add extra components in arch.yaml
      lineinfile:
        path: /etc/software-factory/arch.yaml
        insertafter: '      - {{ item.insertafter | default(omit) }}'
        line: '      - {{ item.component }}'
      loop: '{{ add_component }}'
      when: add_component

    - name: Install extra custom-vars for ci tunning
      copy:
        src: custom-vars.yaml
        dest: /etc/software-factory/custom-vars.yaml

    - name: Remove unsupported components
      block:
        - name: Remove from arch.yaml
          lineinfile:
            path: /etc/software-factory/arch.yaml
            line: '      - {{ item }}'
            state: absent
          loop: '{{ unsupported_components }}'

        - debug:
            msg:
              - 'WARNING: {{ item }} will be removed from arch for'
              - unsupported_components variable was added in the job definition.
          loop: '{{ unsupported_components }}'
      when: unsupported_components

    - include_tasks: configure-static-hostname.yml
      when:
        - static_hostname_ip is defined
        - static_hostname_fqdn is defined

    - include_tasks: configure-main-instance.yml
      when: sf_main_instance

    - include_tasks: configure-tenant-instance.yml
      when: sf_tenant_instance
  become: yes
