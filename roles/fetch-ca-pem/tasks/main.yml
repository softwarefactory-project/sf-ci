- name: Get pem from instance
  synchronize:
    src: /etc/pki/ca-trust/source/anchors/localCA.pem
    dest: '/etc/pki/ca-trust/source/anchors/{{ instance }}.pem'
  delegate_to: '{{ instance }}'
  become: yes
  when: sf_deployment | default(true)

- name: Get pem from opensearch instance
  become: yes
  block:
    - name: Create cert directories
      file:
        path: "{{ item }}"
        state: directory
        recurse: true
      loop:
        - /etc/opensearch/certs/opensearch
        - /etc/zuul/ssl
        # FIXME: remove entry when rename to opensearch is done
        - /etc/elasticsearch/certs

    - name: Get opensearch CA
      synchronize:
        src: "/etc/opensearch/certs/localCA.pem"
        dest: "{{ item }}"
      delegate_to: '{{ instance }}'
      loop:
        - /etc/pki/ca-trust/source/anchors/opensearch.pem
        - /etc/opensearch/certs/opensearch/localCA.pem
        - /etc/zuul/ssl/opensearch.pem
          # FIXME: remove entry when rename to opensearch is done
        - /etc/pki/ca-trust/source/anchors/elasticsearch.pem
        - /etc/elasticsearch/certs/localCA.pem
        - /etc/zuul/ssl/elasticsearch.pem

  when: "not sf_deployment | default(true) "

- name: Update ca trust
  command: update-ca-trust
  become: yes
