- name: Add worker resource
  block:
    - name: Check if config update
      include_role:
        name: wait_for_config_update

    - name: Add worker gerrit connection
      blockinfile:
        path: /root/config/resources/worker.sftests.com.yaml
        create: yes
        block: |
          resources:
            tenants:
              worker:
                description: "The new tenant"
                url: "https://worker.sftests.com/manage"
                default-connection: gerrit-worker

    - name: Push resources configuration
      command: '{{ item }}'
      args:
        chdir: /root/config
      loop:
        - git add resources/worker.sftests.com.yaml
        - git commit -m 'Create worker resource'
        - git push git+ssh://gerrit/config master

    - name: Check if config update
      include_role:
        name: wait_for_config_update

    - name: Ensure worker tenant is present on zuul main.yml
      wait_for:
        path: /etc/zuul/main.yaml
        search_regex: 'worker'
        timeout: 600
  become: true
