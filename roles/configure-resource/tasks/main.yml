- name: Add slave resource
  block:
    - name: Add slave gerrit connection
      blockinfile:
        path: /root/config/resources/slave.sftests.com.yaml
        create: yes
        block: |
          resources:
            tenants:
              slave:
                description: "The new tenant"
                url: "https://slave.sftests.com/manage"
                default-connection: gerrit-slave

    - name: Push resources configuration
      command: '{{ item }}'
      args:
        chdir: /root/config
      loop:
        - git add resources/slave.sftests.com.yaml
        - git commit -m 'Create slave resource'
        - git push git+ssh://gerrit/config master

    - name: Get newrev on config repo
      command: git rev-parse HEAD
      args:
        chdir: /root/config
      register: _rev
      become: yes

    - name: Wait for config-update
      uri:
        url: "https://sftests.com/zuul/api/tenant/local/builds?job_name=config-update&newrev={{ _rev.stdout }}"
        return_content: yes
        body_format: json
      register: _result
      until: _result.json != [] and _result.json[0]["result"] == 'SUCCESS'
      retries: 180
      delay: 30

    - name: Ensure slave tenant is present on zuul main.yml
      wait_for:
        path: /etc/zuul/main.yaml
        search_regex: 'slave'
        timeout: 600
  become: true
