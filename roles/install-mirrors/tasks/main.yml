- name: Install sfinfo repo
  command: >
    ./software-factory/sfinfo/zuul_rpm_setup.py
        --distro-info ./software-factory/sfinfo/sf-{{ zuul.branch }}.yaml
        {{ sfinfo_setup_args }}
  args:
    chdir: "{{ sfnamespace_path }}"
  become: yes

- name: Rename the zuul-built.repo as if it was sf-release so that sf-config does not install the repository
  command: mv /etc/yum.repos.d/zuul-built.repo /etc/yum.repos.d/sf-release.repo
  become: yes

- name: Install sf-master repositories
  include_tasks: install_master_mirror.yml
  when: sf_version == 'master' or update_mirrors

- name: Install sf-stable repositories
  include_tasks: install_stable_mirror.yml
  when:
    - sf_version != 'master'
    - not update_mirrors

- name: Install mirror keys
  copy:
    src: "files/{{ item }}"
    dest: "/etc/pki/rpm-gpg/{{ item }}"
  with_items:
    - RPM-GPG-KEY-CentOS-SIG-SCLo-python35
    - RPM-GPG-KEY-CentOS-SIG-Cloud
  become: yes

- name: Ensure repository mirrors are installed
  yum_repository:
    name: "a{{ item.name }}-mirror"
    description: "SF {{ item.name }}"
    baseurl: "https://softwarefactory-project.io/mirrors/{{ item.name }}/"
    gpgcheck: "1"
    gpgkey: "file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-{{ item.key }}"
    enabled: "1"
    file: "/etc/yum.repos.d/sf-release"
  become: yes
  with_items:
    - name: rh-python35
      key: SCLo-python35
    - name: openstack-queens
      key: Cloud
