---
- name: Set kibana backup directory
  set_fact:
    backup_dest: /var/lib/software-factory/backup/kibana

- name: Gather the rpm package facts
  package_facts:
    manager: auto

- name: Get available service facts
  service_facts:

- name: Get Opendistro or Opensearch admin password
  shell: |
    awk '/elasticsearch_password/ {print $2}' /var/lib/software-factory/bootstrap-data/secrets.yaml
  register: elk_kibanaserver_pass
  when: elasticsearch_password is not defined

- name: Set proper facts for Opendistro or Opensearch
  set_fact:
    additional_params: "--user admin --password {{ elasticsearch_password | default(elk_kibanaserver_pass.stdout) | default('admin') }}"

- name: Determine if Elasticsearch distro is Opendistro
  set_fact:
    opendistro_elk: true
  when: "'opendistroforelasticsearch' in ansible_facts.packages"

- name: Ensure that Kibana backup_dest dir exist
  file:
    path: "{{ backup_dest }}"
    state: directory

- include_tasks: opensearch.yml
  when: opendistro_elk is not defined

- include_tasks: opendistro.yml
  when: opendistro_elk is defined and opendistro_elk
