- name: Submit and approve config change
  command: /usr/share/sf-config/scripts/submit_and_wait.py --approve
  args:
    chdir: "{{ config_path }}"
  register: submit_status
  ignore_errors: true

- name: Register commit sha
  command: cat .git/refs/heads/master
  args:
    chdir: "{{ config_path }}"
  register: commitsha

- name: Install packages to validate zuul-console
  yum:
    name:
      - jq
      - python-websocket-client
  become: yes

- name: grab job uuid
  shell: |
    curl -s {{ zuul_web_url }}/api/tenant/local/status | jq -r '.pipelines[].change_queues[].heads[][].jobs[].uuid'
  register: _job_uuid
  # Wait until the executor start the job
  until: _job_uuid.stdout != "" and "null" not in _job_uuid.stdout
  retries: 60
  delay: 1

- name: connect to console-stream
  shell: |
    (sleep 60; echo "") | wsdump -r -t '{"uuid":"{{ _job_uuid.stdout_lines[0] }}","logfile":"console.log"}' {{ zuul_ws_url }}/api/tenant/local/console-stream
  register: console_stream
  failed_when: false

- name: show console stream
  debug:
    var: console_stream

- name: fail if console stream does not contains expected job output
  when: "'Job console starting...' not in console_stream.stdout"
  # It seems like wsdump.py doesn't always stay connected for the whole job duration
  # when: "'Demo job is running' not in console_stream.stdout"
  fail:
    msg: "Task output is missing from: {{ console_stream.stdout }}"

- name: Wait config-update result using zuul-web API
  uri:
    url: "https://{{ fqdn }}/zuul/api/tenant/local/builds?job_name=config-update&newrev={{ commitsha.stdout }}"
    return_content: yes
    body_format: json
  register: _result
  until: _result.json != [] and _result.json[0]["result"] == 'SUCCESS'
  retries: 180
  delay: 30
