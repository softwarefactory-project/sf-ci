- name: Submit and approve config change
  command: /usr/share/sf-config/scripts/submit_and_wait.py --approve
  args:
    chdir: "{{ config_path }}"
  register: submit_status
  ignore_errors: true

- command: cat .git/refs/heads/master
  args:
    chdir: "{{ config_path }}"
  register: commitsha

- name: Wait config-update result using zuul-web API
  uri:
    url: "https://{{ fqdn }}/zuul/api/tenant/local/builds?job_name=config-update&newrev={{ commitsha.stdout }}"
    return_content: yes
    body_format: json
  register: _result
  until: _result.json != [] and _result.json[0]["result"] == 'SUCCESS'
  retries: 180
  delay: 30
