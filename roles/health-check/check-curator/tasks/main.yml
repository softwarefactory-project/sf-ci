---
- name: Ensure that npm is already instaleld
  yum:
    name: rh-nodejs10-npm
    state: present

- name: Install makelogs
  shell: |
    source scl_source enable rh-nodejs10 ;
    npm install -g "@elastic/makelogs"

- name: Generate logs for testindex prefix
  shell: |
    source scl_source enable rh-nodejs10 ;
    makelogs --url http://{{ fqdn }}:9200 -d 100/10 --verbose --reset --indexPrefix testindex-

- name: Create delete all other indexes
  copy:
    content: |
      actions:
        1:
          action: delete_indices
          description: >-
              Delete data from logstash
          options:
            ignore_empty_list: True
            disable_action: False
          filters:
            - filtertype: pattern
              kind: prefix
              value: logstash-
              exclude: true
    dest: delete-other-indexes.yml

- name: Executing create_index curator rule
  shell: |
    /bin/curator --config /etc/logstash/curator.yml delete-other-indexes.yml
  register: other_index

- name: Check if outpus is wrong for delete-other-indexes
  fail:
    msg: "Curator did not delete any index. Failing"
  when: "'---deleting index testindex-0' not in other_index.stdout"

- name: Generate logs for logstash- prefix
  shell: |
    source scl_source enable rh-nodejs10 ;
    makelogs --url http://{{ fqdn }}:9200 -d 100/10 --verbose --no-reset --indexPrefix testindex-

- name: Create delete_indices rules
  copy:
    content: |
      actions:
        1:
          action: delete_indices
          description: >-
              Delete data from logstash older than 3 days
          options:
            ignore_empty_list: True
            disable_action: False
          filters:
            - filtertype: pattern
              kind: prefix
              value: logstash-
              exclude: true
            - filtertype: age
              source: field_stats
              direction: older
              unit: days
              unit_count: 3
              field: '@timestamp'
              stats_result: min_value
    dest: delete-old-indices.yml

- name: Executing create_index curator rule
  shell: |
    /bin/curator --config /etc/logstash/curator.yml delete-old-indices.yml
  register: old_indices

- name: Check if outpus is wrong for delete-old-indices
  fail:
    msg: "Curator did not delete any index. Failing"
  when: "'---deleting index testindex-0' not in old_indices.stdout"
