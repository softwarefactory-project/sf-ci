---
- name: Ensure that npm is already instaleld
  yum:
    name: rh-nodejs10-npm
    state: present

- name: Install makelogs
  shell: |
    source scl_source enable rh-nodejs10 ;
    npm install -g "@elastic/makelogs"

- name: Generate logs
  shell: |
    source scl_source enable rh-nodejs10 ;
    makelogs --url http://{{ ansible_host }}:9200 -d 70 --no-reset --verbose

- name: Executing create_index curator rule
  shell: |
    /bin/curator --config /etc/logstash/curator.yml /etc/logstash/delete_old_indices.yml
  register: old_indices

- name: Check if outpus is ok
  fail:
    msg: "Curator did not delete any index. Failing"
  when: "'---deleting index logstash-0' not in old_indices.stdout"
