---
- hosts: install-server
  vars:
    # Get sfinfo location
    sfinfo_path_query: "[?name=='software-factory/sfinfo'].src_dir"
    sfinfo_path: "{{ (zuul.projects.values() | list | json_query(sfinfo_path_query))[0] }}"
    # Get sfci location
    sf_ci_path_query: "[?name=='software-factory/sf-ci'].src_dir"
    sf_ci: "{{ (zuul.projects.values() | list | json_query(sf_ci_path_query))[0] }}"
    # Get workspace path to run zuul_rpm_* commands
    sfnamespace_path: "{{ sfinfo_path | dirname | dirname }}"
    sfinfo_setup_args: "{% if buildset_artifacts_url %}--testing-repo {{ buildset_artifacts_url }}{% endif %}"
    sf_user: "zuul-worker"
  tasks:
    - name: "Install sfinfo repo"
      command: >
        ./software-factory/sfinfo/zuul_rpm_setup.py \
            --distro-info ./software-factory/sfinfo/sf-{{ zuul.branch }}.yaml \
            {{ sfinfo_setup_args }}
      args:
        chdir: "{{ sfnamespace_path }}"
      become: yes

    - import_tasks: playbooks/tasks/install_sf_ci_repo.yml
    - import_tasks: playbooks/tasks/yum_update.yml
    - import_tasks: playbooks/tasks/check_bubblewrap.yml
    - import_tasks: playbooks/tasks/run_sfconfig.yml change_fqdn=True
    - import_tasks: playbooks/tasks/run_sfconfig_update_fqdn.yml
    - import_tasks: playbooks/tasks/install_test_env.yml
    - import_tasks: playbooks/tasks/set_environment_facts.yml
    - import_tasks: playbooks/tasks/prevent_bwrap_issue.yml
    - import_tasks: playbooks/tasks/run_provisioner.yml
    - import_tasks: playbooks/tasks/run_backup_create.yml

- import_playbook: playbooks/health-check-zuul.yml

- name: Run health_check gerritbot
  import_playbook: playbooks/health-check-gerritbot.yaml
  when: '"gerritbot" in roles'

# - hosts: install-server
#   tasks:
#     - import_tasks: tasks/run_firehose_listener.yml
#     - import_tasks: tasks/run_functional_tests.yml
#     - import_tasks: tasks/check_firehose_events.yml

# - import_playbook: tasks/run_erase.yml

# - import_playbook: tasks/run_sfconfig_recover.yml

# - hosts: install-server
#   tasks:
#     - import_tasks: tasks/run_checker.yml
