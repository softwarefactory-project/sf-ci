---
- hosts: install-server
  vars:
    # Get sfinfo location
    sfinfo_path_query: "projects[?name=='software-factory/sfinfo'].src_dir"
    sfinfo_path: "{{ (zuul | json_query(sfinfo_path_query))[0] }}"
    # Get sfci location
    sf_ci_path_query: "projects[?name=='software-factory/sf-ci'].src_dir"
    sf_ci: "{{ (zuul | json_query(sf_ci_path_query))[0] }}"
    # Get workspace path to run zuul_rpm_* commands
    sfnamespace_path: "{{ sfinfo_path | dirname | dirname }}"
    sfinfo_setup_args: "{% if buildset_artifacts_url %}--testing-repo {{ buildset_artifacts_url }}{% endif %}"
  tasks:
    - name: "Install sfinfo repo"
      command: >
        ./software-factory/sfinfo/zuul_rpm_setup.py \
            --distro-info ./software-factory/sfinfo/sf-{{ zuul.branch }}.yaml \
            {{ sfinfo_setup_args }}
      args:
        chdir: "{{ sfnamespace_path }}"
      become: yes

    - include: tasks/install_sf_ci_repo.yml
    - include: tasks/yum_update.yml
    - include: tasks/run_sfconfig.yml
