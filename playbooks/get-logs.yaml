---
- hosts: install-server
  vars:
    sf_user: "zuul-worker"
  tasks:
    - name: Check mount points
      command: cat /proc/mounts

    - import_tasks: tasks/set_environment_facts.yml
    - import_tasks: tasks/finish_test.yml

    - name: Remove empty directories
      command: "find {{ artifacts }} -type d -empty -delete"

    - name: Check that the ARA database exists
      become: yes
      stat:
        path: /var/lib/software-factory/ansible/ara/ansible.sqlite
      register: ara_db

    - when: ara_db.stat.exists
      block:
        - name: Create ara-report directory
          file:
            path: "{{ artifacts }}/ara-report"
            state: directory

        - name: Copy the ARA database
          become: yes
          copy:
            src: "{{ ara_db.stat.path }}"
            dest: "{{ artifacts }}/ara-report/ansible.sqlite"
            remote_src: true

    - name: Fetch artifacts
      synchronize:
        src: "{{ artifacts }}/"
        dest: "{{ zuul.executor.log_root }}/logs"
        mode: pull
      no_log: True
