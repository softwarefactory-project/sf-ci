- name: Prepare yum repositories
  block:
  - name: Install CentOS CR repository
    command: yum-config-manager --enable cr
    when: centos_cr is defined and centos_cr

  - name: Setup /etc/sf-release file
    copy:
      content: "{{ sf_version }}"
      dest: /etc/sf-release

  - name: Install mirror keys
    copy:
      src: "files/{{ item }}"
      dest: "/etc/pki/rpm-gpg/{{ item }}"
    with_items:
      - RPM-GPG-KEY-CentOS-SIG-SCLo-python35
      - RPM-GPG-KEY-CentOS-SIG-Cloud
    become: yes

  - name: Ensure repository mirrors are installed
    yum_repository:
      name: "a{{ item.name }}-mirror"
      description: "SF {{ item.name }}"
      baseurl: "https://softwarefactory-project.io/mirrors/{{ item.name }}/"
      gpgcheck: "1"
      gpgkey: "file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-{{ item.key }}"
      enabled: "1"
      file: "/etc/yum.repos.d/sf-release"
    become: yes
    with_items:
      - name: rh-python35
        key: SCLo-python35
      - name: openstack-queens
        key: Cloud
  become: yes
