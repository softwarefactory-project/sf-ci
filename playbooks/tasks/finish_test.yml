- name: Restore jenkins shell
  command: "sed -i '/^jenkins/ s#:[^:]*$#:/bin/bash#' /etc/passwd"
  become: yes
  become_user: root

- name: Check for get_logs playbook
  stat: path=/var/lib/software-factory/ansible/get_logs.yml
  register: get_logs_playbook
  become: yes
  become_user: root

- block:
    - name: Run get-logs playbook
      command: ansible-playbook /var/lib/software-factory/ansible/get_logs.yml
      become: yes
      become_user: root

    - name: Copy sf-logs
      command: "rsync -a --no-links /root/sf-logs/ {{ artifacts }}/"
      become: yes
      become_user: root
  when: get_logs_playbook.stat.exists

- name: Ensure artifacts are owned by user
  file:
    path: "{{ artifacts }}"
    owner: "{{ ansible_user_id }}"
    recurse: yes
  become: yes
  become_user: root

- name: Create an artifact tarball
  command: "tar -czf {{ artifacts }}.tgz {{ artifacts }}/"

- name: Move artifact tarball to artifacts directory
  command: "mv {{ artifacts }}.tgz {{ artifacts }}/"

- name: Check nose_results.html
  stat: path=nose_results.html
  register: nose_results

- name: Move nose_results.html in artifacts directory
  command: "mv nose_results.html {{ artifacts }}/"
  when: nose_results.stat.exists
