---
- block:
    - name: Install sf-config package
      yum:
        name: sf-config
        state: latest
        exclude: ansible
        update_cache: yes

    - name: Check if sfconfig.yaml.rpmnew exists
      stat:
        path: /etc/software-factory/sfconfig.yaml.rpmnew
      register: sfconfig_rpmnew

    - name: Ensure last sfconfig.yaml version
      copy:
        src: /etc/software-factory/sfconfig.yaml.rpmnew
        dest: /etc/software-factory/sfconfig.yaml
        remote_src: true
      when: sfconfig_rpmnew.stat.exists

    - name: Run sfconfig --upgrade
      command: sfconfig --upgrade

    - name: Collect package upgraded
      shell: "rpm -qa | sort > package_upgraded"

    - name: Package diff
      shell: "diff /var/lib/software-factory/package_installed package_upgraded  | tee {{ artifacts }}/package_upgrade.txt"
      register: package_diff
      failed_when: package_diff.rc not in [0, 1]
  become: yes
