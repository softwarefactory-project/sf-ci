---
- name: Install sf-config package
  yum:
    name: sf-config
    state: latest
    exclude: ansible
    update_cache: yes
  become: yes

# Special fixes for job-log-gearman
- name: Remove job-log-gearman
  lineinfile:
    path: /etc/software-factory/arch.yaml
    line: "{{ item }}"
    state: absent
  become: yes
  with_items:
    - "      - job-logs-gearman-client"
    - "      - job-logs-gearman-worker"

- name: "Run sfconfig --upgrade"
  command: sfconfig --upgrade
  become: yes

- name: "Collect package upgraded"
  shell: "rpm -qa | sort > package_upgraded"

- name: "Package diff"
  shell: "diff /var/lib/software-factory/package_installed package_upgraded  | tee {{ artifacts }}/package_upgrade.txt"
  register: package_diff
  failed_when: package_diff.rc not in [0, 1]
  become: yes
