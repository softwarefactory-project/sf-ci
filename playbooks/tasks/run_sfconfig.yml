- name: Install sf-config package
  yum:
    name: sf-config
    exclude: ansible
    state: latest
  become: yes

- name: Install SF architecture file {{ sf_arch }}.yaml
  copy:
    src: "/usr/share/sf-config/refarch/{{ sf_arch }}.yaml"
    dest: /etc/software-factory/arch.yaml
    remote_src: true
  become: yes

- name: Install extra custom-vars for mirrors
  copy:
    src: "{{ sf_ci }}/patches/custom-vars.yaml"
    dest: /etc/software-factory/custom-vars.yaml
    remote_src: true
  become: yes

# Since 2.7 the hypervisor-oci role must be activated in the CI
- name: Activate hypervisor-oci role in the arch.yaml file
  lineinfile:
    path: /etc/software-factory/arch.yaml
    insertafter: '      - nodepool3-launcher'
    line: '      - hypervisor-oci'
  when: "sf_version != '2.6'"
  become: yes

# Special fixes for job-log-gearman
- name: Remove job-log-gearman
  lineinfile:
    path: /etc/software-factory/arch.yaml
    line: "{{ item }}"
    state: absent
  with_items:
    - "      - job-logs-gearman-client"
    - "      - job-logs-gearman-worker"

# Special fixes for ansible 2.4
- name: "Patch zuul2 ansiblelauncher for ansible 2.4"
  shell: "patch /usr/lib/python2.7/site-packages/zuul/launcher/ansiblelaunchserver.py < {{ sf_ci }}/patches/ansiblelauncher-ansible-2.4.patch"
  become: yes
  ignore_errors: yes

- name: "Patch sfconfig jenkins install.yaml for ansible 2.4"
  shell: "patch /usr/share/sf-config/ansible/roles/sf-jenkins/tasks/install.yml < {{ sf_ci }}/patches/jenkins-install-yaml-cert-issue-ansible-2.4.patch"
  become: yes
  ignore_errors: yes

- name: Run sfconfig
  command: sfconfig
  become: yes

- include: update_bootstrap_mode.yml
