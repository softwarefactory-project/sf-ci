- name: Install sf-config package
  yum:
    name: sf-config
    exclude: ansible
    state: latest
  become: yes

- name: Install SF architecture file {{ sf_arch }}.yaml
  copy:
    src: "/usr/share/sf-config/refarch/{{ sf_arch }}.yaml"
    dest: /etc/software-factory/arch.yaml
    remote_src: true
  become: yes

- name: Install extra custom-vars for mirrors
  copy:
    src: "{{ sf_ci }}/patches/custom-vars.yaml"
    dest: /etc/software-factory/custom-vars.yaml
    remote_src: true
  become: yes

# Since 2.7 the hypervisor-oci role must be activated in the CI
- name: Activate hypervisor-oci role in the arch.yaml file
  lineinfile:
    path: /etc/software-factory/arch.yaml
    insertafter: '      - nodepool-launcher'
    line: '      - hypervisor-oci'
  become: yes

# Make sure /etc/nodepool doesn't exists
- name: "Ensure /etc/nodepool doesn't exists"
  file:
    path: /etc/nodepool
    state: absent
  become: yes

- name: Update fqdn in sfconfig.yaml
  lineinfile:
    path: /etc/software-factory/sfconfig.yaml
    regexp: '^fqdn:'
    line: 'fqdn: sfdomain.com'
  become: yes

- name: Run sfconfig
  command: sfconfig
  become: yes

- include: update_bootstrap_mode.yml
