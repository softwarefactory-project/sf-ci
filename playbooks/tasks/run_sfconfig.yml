- name: Install sf-config package
  yum:
    name: sf-config
    exclude: ansible
    state: latest
  become: yes

- name: Install SF architecture file {{ sf_arch }}.yaml
  copy:
    src: "/usr/share/sf-config/refarch/{{ sf_arch }}.yaml"
    dest: /etc/software-factory/arch.yaml
  become: yes

- name: Install extra custom-vars for mirrors
  copy:
    src: "{{ sf_ci }}/patches/custom-vars.yaml"
    dest: /etc/software-factory/custom-vars.yaml
  become: yes

# Since 2.7 the hypervisor-oci role must be activated in the CI
- name: Activate hypervisor-oci role in the arch.yaml file
  shell: "grep -q 'hypervisor-oci' /etc/software-factory/arch.yaml || sed -i 's/.*- nodepool3-launcher.*/&\\n      - hypervisor-oci/' /etc/software-factory/arch.yaml"
  when: "sf_version != '2.6'"

# Special fix for 2.5.0
- block:
  - file:
      path: "{{ item }}"
      mode: 0700
      state: directory
    with_items:
      - /root/.ssh
      - /etc/serverspec
    become: yes

  - name: Fix arch
    copy:
      src: "{{ sf_ci }}/patches/2.5.0-minimal.yaml"
      dest: /etc/software-factory/arch.yaml
    become: yes

  - name: Fix gitweb install
    replace:
      dest: "/usr/share/sf-config/ansible/roles/sf-gitweb/tasks/install.yml"
      regexp: " theme "
      replace: " gitweb_theme "
    become: yes
  - name: Fix gitweb default
    replace:
      dest: "/usr/share/sf-config/ansible/roles/sf-gitweb/defaults/main.yml"
      regexp: "^theme:"
      replace: "gitweb_theme:"
    become: yes
  when: "sf_version == '2.5'"

# Special fixes for ansible 2.4
- name: "Patch zuul2 ansiblelauncher for ansible 2.4"
  shell: "patch /usr/lib/python2.7/site-packages/zuul/launcher/ansiblelaunchserver.py < {{ sf_ci }}/patches/ansiblelauncher-ansible-2.4.patch"
  become: yes
  ignore_errors: yes

- name: "Patch sfconfig jenkins install.yaml for ansible 2.4"
  shell: "patch /usr/share/sf-config/ansible/roles/sf-jenkins/tasks/install.yml < {{ sf_ci }}/patches/jenkins-install-yaml-cert-issue-ansible-2.4.patch"
  become: yes
  ignore_errors: yes

- name: Run sfconfig
  command: sfconfig
  become: yes

- include: update_bootstrap_mode.yml
