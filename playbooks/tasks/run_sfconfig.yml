- name: Install and run sfconfig
  block:
    - name: Install sf-config package
      yum:
        name: sf-config
        exclude: ansible
        state: latest

    - name: Install SF architecture file {{ sf_arch }}.yaml
      copy:
        src: "/usr/share/sf-config/refarch/{{ sf_arch }}.yaml"
        dest: /etc/software-factory/arch.yaml
        remote_src: true

    - name: Install extra custom-vars for mirrors
      copy:
        src: "{{ sf_ci }}/patches/custom-vars.yaml"
        dest: /etc/software-factory/custom-vars.yaml
        remote_src: true

    - name: Activate hypervisor-oci role in the arch.yaml file
      lineinfile:
        path: /etc/software-factory/arch.yaml
        insertafter: '      - nodepool-launcher'
        line: '      - hypervisor-oci'

    - name: Update fqdn in sfconfig.yaml
      lineinfile:
        path: /etc/software-factory/sfconfig.yaml
        regexp: '^fqdn:'
        line: 'fqdn: sfdomain.com'
      when: change_fqdn is defined

    - name: Update hostname
      hostname:
        name: "{% if change_fqdn is defined %}managesf.sfdomain.com{% else %}managesf.sftests.com{% endif %}"

    - name: Run sfconfig
      command: sfconfig
  become: yes

- include: update_bootstrap_mode.yml
