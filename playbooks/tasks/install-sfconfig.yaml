---
- name: "Set ci facts"
  set_fact:
    sfinfo_path_query: "[?name=='software-factory/sfinfo'].src_dir"
    sf_ci_path_query: "[?name=='software-factory/sf-ci'].src_dir"
    sfinfo_setup_args: "{% if buildset_artifacts_url %}--testing-repo {{ buildset_artifacts_url }}{% endif %}"
    sf_user: "zuul-worker"

- name: "Discover paths"
  set_fact:
    sfinfo_path: "{{ (zuul.projects.values() | list | json_query(sfinfo_path_query))[0] }}"
    sf_ci: "{{ (zuul.projects.values() | list | json_query(sf_ci_path_query))[0] }}"

- name: "Discover namespace path"
  set_fact:
    sfnamespace_path: "{{ sfinfo_path | dirname | dirname }}"

- name: "Install sfinfo repo"
  command: >
    ./software-factory/sfinfo/zuul_rpm_setup.py \
        --distro-info ./software-factory/sfinfo/sf-{{ zuul.branch }}.yaml \
        {{ sfinfo_setup_args }}
  args:
    chdir: "{{ sfnamespace_path }}"
  become: yes

- import_tasks: install_sf_ci_repo.yml
- import_tasks: yum_update.yml

- name: Set hostname
  hostname:
    name: managesf.sftests.com
  become: yes

- name: Install sf-config package
  yum:
    name: sf-config
    state: latest
  become: yes

- name: Install extra custom-vars for ci tunning
  copy:
    src: "{{ sf_ci }}/patches/custom-vars.yaml"
    dest: /etc/software-factory/custom-vars.yaml
    remote_src: true
  become: yes
