---
- hosts: install-server
  vars:
    # Get sfinfo location
    sfinfo_path_query: "[?name=='software-factory/sfinfo'].src_dir"
    sfinfo_path: "{{ (zuul.projects.values() | list | json_query(sfinfo_path_query))[0] }}"
    # Get sfci location
    sf_ci_path_query: "[?name=='software-factory/sf-ci'].src_dir"
    sf_ci: "{{ (zuul.projects.values() | list | json_query(sf_ci_path_query))[0] }}"
    # Get workspace path to run zuul_rpm_* commands
    sfnamespace_path: "{{ sfinfo_path | dirname | dirname }}"
    sfinfo_setup_args: "{% if buildset_artifacts_url %}--testing-repo {{ buildset_artifacts_url }}{% endif %}"
    sf_user: "zuul-worker"
  roles:
    - install-sfinfo-repo
    - install-sf-ci-repo
    - yum-update
    - check-bubblewrap
    - role: run-sfconfig
      change-fqdn: True
    - run-sfconfig-update-fqdn
    - install-test-env
    - set-environment-facts
    - run-provisioner
    - run-backup-create
    - run-health-check
    - run-firehose-listener
    - run-functional-tests
    - check-firehose-events
    - run-erase
    - run-sfconfig-recover
    - run-checker
