---
- hosts: install-server
  tasks:
    - name: Prepare ci instance
      include_role:
        name: '{{ item }}'
      loop:
        - prepare-test-env
        - install-mirrors
        - update-system
        - check-bubblewrap
        - install-sfconfig
        - configure-sfconfig

    - name: Set hostname sfdomain.com
      include_role:
        name: set-hostname
      vars:
        domain: sfdomain.com

    - name: Run sfconfig
      include_role:
        name: run-sfconfig

    - name: Set hostname sftests.com
      include_role:
        name: set-hostname
      vars:
        domain: sftests.com

    - name: Run sfconfig to update fqdn
      include_role:
        name: run-sfconfig
      vars:
        sfconfig_args: --skip-install

    - name: Run functional tests and health-check
      include_role:
        name: '{{ item }}'
      loop:
        - setup-test-env
        - run-provisioner
        - run-backup-create
        - run-health-check
        - run-firehose-listener
        - run-functional-tests
        - check-firehose-events

    - name: Erase the system
      include_role:
        name: run-erase

    - name: Restore backup
      include_role:
        name: run-sfconfig
      vars:
        sfconfig_args: --recover

    - name: Validate after backup recovery
      include_role:
        name: run-checker
