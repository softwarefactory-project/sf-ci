---
- hosts: install-server
  roles:
    - install-mirrors
    - update-system
    - install-sfconfig
    - role: configure-sfconfig
      add_component:
        - component: hypervisor-openshift
          insertafter: nodepool-launcher
    - set-hostname
    - role: run-sfconfig
      sfconfig_args: --provision-demo
  tasks:
    - name: Execute health-check
      command: >
        ansible-playbook -i /var/lib/software-factory/ansible/hosts
            -e @{{ sf_ci }}/health-check/group_vars/all.yaml
            {{ sf_ci }}/health-check/zuul-openshift.yaml
      become: yes
      ignore_errors: yes
      register: health_check

    - name: Fetch job artifacts
      synchronize:
        src: /var/www/logs
        dest: "{{ zuul.executor.log_root }}/job-logs"
        mode: pull
      no_log: True

    - name: Fetch nodepool launcher logs
      synchronize:
        src: /var/log/nodepool
        dest: "{{ zuul.executor.log_root }}/nodepool"
        mode: pull
      no_log: True
      become: yes

    - name: Fail if health-check failed
      fail:
        msg: Health check failed
      when: health_check is failed
