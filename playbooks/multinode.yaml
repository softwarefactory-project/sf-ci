---
- hosts: master
  tasks:
    - name: Get slave ip in /etc/hosts files (configured by multinode parent)
      command: awk '/slave/ {print $1}' /etc/hosts
      register: host_slave_ip

    - set_fact:
        slave_ip: '{{ host_slave_ip.stdout }}'

- hosts: slave
  tasks:
    - name: Get master ip in /etc/hosts files (configured by multinode parent)
      command: awk '/master/ {print $1}' /etc/hosts
      register: host_master_ip

    - set_fact:
        master_ip: '{{ host_master_ip.stdout }}'

- hosts: all
  tasks:
    - name: Prepare instance
      include_role:
        name: '{{ item }}'
      loop:
        - prepare-test-env
        - install-mirrors
        - update-system
        - install-sfconfig

- hosts: master
  tasks:
    - name: Configure sfconfig
      include_role:
        name: configure-sfconfig

    - name: Run sfconfig
      include_role:
        name: run-sfconfig

- hosts: slave
  tasks:
    - name: Fetch master CA pem file
      include_role:
        name: fetch-ca-pem
      vars:
        instance: master

    - name: Configure hostname and fqdn
      include_role:
        name: configure-fqdn
      vars:
        domain: slave.sftests.com

    - name: Configure sfconfig
      include_role:
        name: configure-sfconfig
      vars:
        sf_arch: tenant-minimal
        add_runc_hypervisor: false
        add_component:
          - component: gerrit
            insertafter: cauth
          - component: gitweb
          - component: elasticsearch
          - component: repoxplorer
          - component: hound
        sf_tenant_instance: true
        static_hostname_ip: '{{ master_ip }}'
        static_hostname_fqdn: sftests.com

    - name: Run sfconfig
      include_role:
        name: run-sfconfig

- hosts: master
  tasks:
    - name: Fetch master CA pem file
      include_role:
        name: fetch-ca-pem
      vars:
        instance: slave

    - name: Add gerrit connection in sfconfig.yaml
      include_role:
        name: configure-sfconfig
      vars:
        sf_main_instance: true
        static_hostname_ip: '{{ slave_ip }}'
        static_hostname_fqdn: slave.sftests.com

    - name: Run sfconfig to apply configuration
      include_role:
        name: run-sfconfig
      vars:
        sfconfig_args: --skip-install

    - name: Add resources in the config repo
      include_role:
        name: configure-resource

- hosts: slave
  tasks:
    - name: Run sfconfig to finalize configuration
      include_role:
        name: run-sfconfig
      vars:
        sfconfig_args: --skip-install

# this should not be needed but zuul didn't reconfigure when
# base, config-check and config-update are added in the last
# commit of the slave/config.
- hosts: master
  tasks:
    - name: Reload zuul-scheduler
      systemd:
        name: rh-python35-zuul-scheduler
        state: reloaded
      become: true

- hosts: slave
  tasks:
    - name: Validate tenant
      include_role:
        name: health-check/add_resources
