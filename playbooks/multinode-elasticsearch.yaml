---
- hosts: elk
  become: true
  vars:
    # NOTE: the hide_sensitive_logs is set to false in Zuul CI jobs.
    hide_sensitive_logs: false
    fqdn: opensearch.sftests.com
    tenant_configuration:
      sftests.com:
        kibana_autologin: "basic"
    internal_users:
      - user: "admin"
        role: "admin"
        password: "admin"
      - user: "kibanaserver"
        role: "kibanauser"
        password: "kibanaserver"
    users:
      - user: "admin"
        role: "admin"
        password: "admin"
        tenant: "sftests.com"
      - user: "logstash"
        role: "logstash"
        password: "logstash"
        tenant: "sftests.com"
      - user: "kibana"
        role: "readonly"
        password: "kibana"
        tenant: "sftests.com"
        # NOTE: remove after merging:
        # https://softwarefactory-project.io/r/c/software-factory/ansible-role-elastic-recheck/+/22512
        autologin: "basic"
      - user: "zuul"
        role: "admin"
        password: "zuul"
        tenant: "sftests.com"
  tasks:
    - name: Install rsync package
      become: true
      package:
        name: rsync
        state: present

    - name: Set hostname
      hostname:
        name: "{{ fqdn }}"

    # FIXME: Change line when rename to Opensearch is done
    - name: Ensure that correct hostname is set in hosts file
      become: true
      lineinfile:
        dest: '/etc/hosts'
        regexp: "^{{ fqdn }}.+$"
        line: "{{ ansible_host }} {{ inventory_hostname_short }} {{ fqdn }} elasticsearch.sftests.com elasticsearch"

    - name: Setup ES stack
      include_role:
        name: "{{ zuul.projects['softwarefactory-project.io/software-factory/ansible-role-elastic-recheck'].src_dir }}"
        tasks_from: main.yaml

    - name: Run functional tests
      include_role:
        name: run-opensearch-tox

- hosts: master
  tasks:
    - set_fact:
        elk_ip: "{{ hostvars['elk']['ansible_default_ipv4']['address'] }}"

- hosts: elk
  tasks:
    - set_fact:
        master_ip: "{{ hostvars['master']['ansible_default_ipv4']['address'] }}"

- hosts: master
  vars:
    add_k1s_hypervisor: true
  tasks:
    - name: Prepare instance
      include_role:
        name: '{{ item }}'
      loop:
        - prepare-test-env
        - install-ci-repository
        - install-sfconfig

    - name: Configure sfconfig
      include_role:
        name: configure-sfconfig
      vars:
        sf_arch: allinone
        static_hostname_ip: '{{ elk_ip }}'
        # FIXME: Change line after renaming elasticsearch to opensearch
        static_hostname_fqdn: "opensearch.sftests.com elasticsearch.sftests.com"
        remove_component:
          # FIXME: change to opensearch when 25354 is merged.
          - component: elasticsearch
          - component: kibana
          - component: logstash

    - name: Configure external_opensearch users
      include_role:
        name: configure-external-elasticsearch-host
      vars:
        # NOTE: ansible-elastic-recheck project does not provide https for
        # Opensearch Dashboards.
        kibana_host: "https://opensearch.sftests.com:5601"
        readonly_user_autologin: "basic"
        # FIXME: Change line after renaming elasticsearch to opensearh
        elasticsearch_host: "https://opensearch.sftests.com:9200"
        opensearch_host: "https://opensearch.sftests.com:9200"
        cacert_path: "/etc/opensearch/certs/opensearch/localCA.pem"
        suffix: sftests_com
        users:
          admin_sftests_com:
            role: admin
            password: admin
          logstash_sftests_com:
            role: logstash
            password: logstash
          # Readonly user
          kibana_sftests_com:
            role: readonly
            password: kibana
          zuul_sftests_com:
            role: zuul
            password: zuul
        opensearch_connections:
          - name: opensearch_sftest_com
            username: zuul_sftests_com
            password: zuul
            host: opensearch.sftests.com
            port: 9200
            use_ssl: true
            ca_certs: /etc/zuul/ssl/opensearch.pem
            index: "zuul"
        # FIXME: change Change line after renaming elasticsearch to opensearch
        elasticsearch_connections:
          - name: opensearch_sftest_com
            username: zuul_sftests_com
            password: zuul
            host: opensearch.sftests.com
            port: 9200
            use_ssl: true
            ca_certs: /etc/zuul/ssl/opensearch.pem
            index: "zuul"

    - name: Fetch master CA pem file and opensearch certs
      include_role:
        name: fetch-ca-pem
      vars:
        instance: elk
        sf_deployment: false

    - name: Run sfconfig
      include_role:
        name: run-sfconfig
      vars:
        sfconfig_args: --provision-demo --enable-insecure-workers

    - name: Run functional tests and health-check
      include_role:
        name: '{{ item }}'
      loop:
        - setup-test-env
        - run-provisioner
        - run-health-check
        - run-functional-tests
