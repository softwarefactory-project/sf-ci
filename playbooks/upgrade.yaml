---
- hosts: install-server
  tasks:
    - name: Prepare instance
      include_role:
        name: '{{ item }}'
      loop:
        - prepare-test-env
        - install-stable-repository
        - check-bubblewrap
        - install-sfconfig
        - configure-sfconfig
        - configure-fqdn

    - name: Deploy sf and setup test env
      include_role:
        name: '{{ item }}'
      loop:
        - run-sfconfig
        - restore-ci-repo

    - name: Run provisioner
      include_role:
        name: run-provisioner

    - name: Update mirrors to use sfmaster
      include_role:
        name: install-ci-repository

    - name: Update sfconfig package
      include_role:
        name: install-sfconfig

    # Remove next two tasks once sf-3.5 is released
    - name: Activate hypervisor-k1s role in arch.yaml
      become: yes
      lineinfile:
        path: /etc/software-factory/arch.yaml
        insertafter: '      - nodepool-launcher'
        line: '      - hypervisor-k1s'

    - name: Patch k1s/centos image to include yamllint for health-check job
      become: yes
      shell: |
        cp /usr/share/sf-config/ansible/roles/sf-repos/files/config/containers/centos-7/Dockerfile /root/config/containers/centos-7/Dockerfile
        cd /root/config
        git commit -a -m "Force update centos-7"
        git push gerrit master

    - name: Run sfconfig upgrade
      include_role:
        name: run-sfconfig
      vars:
        sfconfig_args: --upgrade

    - name: Run functional tests and health-check
      include_role:
        name: '{{ item }}'
      loop:
        - setup-test-env
#        - run-checker
        - run-health-check
        - run-functional-tests
