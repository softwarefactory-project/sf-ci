---
- hosts: install-server
  vars:
    # Get sfinfo location
    sfinfo_path_query: "[?name=='software-factory/sfinfo'].src_dir"
    sfinfo_path: "{{ (zuul.projects.values() | list | json_query(sfinfo_path_query))[0] }}"
    # Get sfci location
    sf_ci_path_query: "[?name=='software-factory/sf-ci'].src_dir"
    sf_ci: "{{ (zuul.projects.values() | list | json_query(sf_ci_path_query))[0] }}"
    # Get workspace path to run zuul_rpm_* commands
    sfnamespace_path: "{{ sfinfo_path | dirname | dirname }}"
    sfinfo_setup_args: "{% if buildset_artifacts_url %}--testing-repo {{ buildset_artifacts_url }}{% endif %}"
    sf_user: "zuul-worker"
  tasks:
    - name: "Install sfinfo repo"
      command: >
        ./software-factory/sfinfo/zuul_rpm_setup.py \
            --distro-info ./software-factory/sfinfo/sf-{{ zuul.branch }}.yaml \
            {{ sfinfo_setup_args }}
      args:
        chdir: "{{ sfnamespace_path }}"
      become: yes

    - include_tasks: tasks/install_stable_repo.yml
    - include_tasks: tasks/yum_update.yml
    - include_tasks: tasks/check_bubblewrap.yml
    - include_tasks: tasks/run_sfconfig.yml
    - include_tasks: tasks/install_test_env.yml
    - include_tasks: tasks/restore_ci_repo.yml
    - include_tasks: tasks/install_sf_ci_repo.yml
    - include_tasks: tasks/install_sf_ci_packages.yml
    - include_tasks: tasks/set_environment_facts.yml
    - include_tasks: tasks/prevent_bwrap_issue.yml
    - include_tasks: tasks/run_provisioner.yml
    - include_tasks: tasks/run_sfconfig_upgrade.yml
    - include_tasks: tasks/run_checker.yml
    - include_tasks: tasks/run_health-check.yml
    - include_tasks: tasks/run_functional_tests.yml
